#!/bin/bash

# ==============================================================================
# ðŸ“˜ UNIVERSAL SYSTEM CLEANER & LOG ROTATOR (Linux)
#
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ Linux-ÑÐµÑ€Ð²ÐµÑ€Ñ‹:
# â–ª ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÑŽ Ð»Ð¾Ð³Ð¾Ð² (logrotate + journald)
# â–ª ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¸ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
# â–ª Ð£Ð´Ð°Ð»ÑÐµÑ‚ Docker-Ð¼ÑƒÑÐ¾Ñ€ (ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð¾Ð±Ñ€Ð°Ð·Ñ‹, ÑÐµÑ‚Ð¸)
# â–ª Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹
# â–ª ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ ÐºÑÑˆ
#
# ðŸ”§ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½ÑƒÑŽ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½-ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²
# ðŸ’£ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð³Ð»ÑƒÐ±Ð¾ÐºÑƒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¼ÐµÑÑ‚Ð¾)
# ðŸ“‹ ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð¼ÐµÐ½ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
#
# ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°: Ubuntu, Debian, Linux VPS
# ==============================================================================

### ðŸ”¹ ÐžÐ±Ñ‰Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ: Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
confirm() {
    local prompt="$1"
    read -p "$prompt [y/n, Enter = yes]: " choice
    case "$choice" in
        ""|y|Y|yes|Yes) return 0 ;;    # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
        n|N|no|No) return 1 ;;         # ÐžÑ‚ÐºÐ°Ð·
        *) echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ y Ð¸Ð»Ð¸ n."; confirm "$prompt" ;;  # ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ
    esac
}

### ðŸ”¹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð¿Ð¾ÑÐ»Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ (Ð¸ Ð°Ð²Ð°Ñ€Ð¸Ð¹Ð½Ñ‹Ð¹ Ð²Ñ‹Ñ…Ð¾Ð´)
check_success() {
    if [ $? -ne 0 ]; then
        echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ: $1"
        exit 1
    fi
}

### 1ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° logrotate Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¾Ð²
# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ñ„Ð°Ð¹Ð» /etc/logrotate.d/my_syslog_kernlog
# ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ syslog Ð¸ kern.log Ð´Ð¾ 100MB, Ñ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾Ð¹ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÐµÐ¹
setup_logrotate() {
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° logrotate..."
    sudo apt update && sudo apt install -y logrotate
    check_success "ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° logrotate"

    sudo tee /etc/logrotate.d/my_syslog_kernlog > /dev/null <<EOL
/var/log/syslog /var/log/kern.log {
    daily
    rotate 1
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root adm
    postrotate
        systemctl reload rsyslog > /dev/null 2>/dev/null || true
    endscript
}
EOL
    sudo logrotate -f /etc/logrotate.d/my_syslog_kernlog -v
    echo "âœ… logrotate Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ syslog Ð¸ kern.log"
}

### 2ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° journald â€” Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ systemd
# Ð—Ð°Ð´Ð°Ñ‘Ñ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð¿Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñƒ (100MB) Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ (2 Ð´Ð½Ñ)
setup_journald() {
    echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° journald..."
    sudo tee /etc/systemd/journald.conf > /dev/null <<EOL
[Journal]
SystemMaxUse=100M
MaxRetentionSec=2d
EOL
    sudo systemctl restart systemd-journald.socket
    sudo systemctl restart systemd-journald
    echo "âœ… journald Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
}

### 3ï¸âƒ£ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° rsyslog â€” Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð² /var/log
# Ð•ÑÐ»Ð¸ Ð¿Ð¾ ÐºÐ°ÐºÐ¸Ð¼-Ñ‚Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°Ð¼ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ (Ñ€ÐµÐ´ÐºÐ¾)
install_rsyslog() {
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° rsyslog..."
    sudo apt update && sudo apt install -y rsyslog
    check_success "ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° rsyslog"
    echo "âœ… rsyslog ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
}

### 4ï¸âƒ£ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ (Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)
# Ð£Ð´Ð°Ð»ÑÐµÑ‚ syslog, kern.log, Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð¶ÑƒÑ€Ð½Ð°Ð»Ñ‹ journald Ð¸ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹ Ð»Ð¾Ð³Ð¾Ð²
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ñ€Ð¸ Ð½ÐµÑ…Ð²Ð°Ñ‚ÐºÐµ Ð¼ÐµÑÑ‚Ð°)
clear_logs() {
    if confirm "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¸ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸?"; then
        sudo journalctl --vacuum-time=1s
        sudo find /var/log -type f \( -name "*.gz" -o -name "*.xz" -o -name "*.tar" -o -name "*.zip" \) -delete
        sudo rm -f /var/log/syslog* /var/log/kern.log*
        sudo systemctl restart rsyslog
        echo "âœ… Ð›Ð¾Ð³Ð¸ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹"
    fi
}

### 5ï¸âƒ£ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Docker: ÑƒÐ´Ð°Ð»ÑÐµÑ‚ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð¾Ð±Ñ€Ð°Ð·Ñ‹, Ñ‚Ð¾Ð¼Ð° Ð¸ ÑÐµÑ‚Ð¸
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ, ÐµÑÐ»Ð¸ Ð²Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ Ð¸ Ð¾ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸ Ð¼ÑƒÑÐ¾Ñ€ Ð² Docker
clear_docker() {
    if confirm "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ docker-Ñ€ÐµÑÑƒÑ€ÑÑ‹ (ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð¾Ð±Ñ€Ð°Ð·Ñ‹, ÑÐµÑ‚Ð¸)?"; then
        sudo docker system prune -a -f
        echo "âœ… Docker Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½"
    fi
}

### 6ï¸âƒ£ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð² Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ (*.tar, *.gz, *.zip)
# Ð£Ð´Ð¾Ð±Ð½Ð¾ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¿Ð°Ð¿ÐºÐ¸ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº Ð¸Ð»Ð¸ Ð±Ð¸Ð»Ð´Ð¾Ð²
delete_archives() {
    if confirm "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ (*.tar, *.gz, *.zip)?"; then
        find . -type f \( -name "*.tar" -o -name "*.gz" -o -name "*.zip" \) -exec rm -v {} \;
        echo "âœ… ÐÑ€Ñ…Ð¸Ð²Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
    fi
}

### 7ï¸âƒ£ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÐºÑÑˆÐ°
# Ð£Ð´Ð°Ð»ÑÐµÑ‚: apt-ÐºÑÑˆ, Ð¿Ð°ÐºÐµÑ‚Ñ‹, thumbnails, pagecache
# ÐŸÐ¾Ð»ÐµÐ·Ð½Ð¾ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹, ÑÐ±Ð¾Ñ€Ð¾Ðº, Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
clear_cache() {
    if confirm "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÑÑˆ (apt, thumbnails, drop_caches)?"; then
        sudo apt clean
        sudo apt autoremove --purge -y
        sudo sync; sudo sysctl -w vm.drop_caches=3
        rm -rf ~/.cache/thumbnails/*
        echo "âœ… ÐšÑÑˆ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½"
    fi
}

### 8ï¸âƒ£ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
# ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð²Ñ‹Ð±Ð¾Ñ€ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¸Ð»Ð¸ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°
main_menu() {
    while true; do
        echo ""
        echo "========= ðŸ§¹ UNIVERSAL SYSTEM CLEANER ========="
        echo "1) ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ logrotate (Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð²)"
        echo "2) ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ journald (Ð»Ð¸Ð¼Ð¸Ñ‚ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð²)"
        echo "3) Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ rsyslog (ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)"
        echo "4) ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ (Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾)"
        echo "5) ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Docker (ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹/Ð¾Ð±Ñ€Ð°Ð·Ñ‹)"
        echo "6) Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð¿Ð°Ð¿ÐºÐµ"
        echo "7) ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ ÐºÑÑˆ"
        echo "8) Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð²ÑÑ‘ ÑÑ€Ð°Ð·Ñƒ (Safe Mode: 1â€“3 + 5â€“7)"
        echo "0) Ð’Ñ‹Ð¹Ñ‚Ð¸"
        echo "==============================================="
        read -p "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: " choice

        case "$choice" in
            1) setup_logrotate ;;
            2) setup_journald ;;
            3) install_rsyslog ;;
            4) clear_logs ;;
            5) clear_docker ;;
            6) delete_archives ;;
            7) clear_cache ;;
            8)
                setup_logrotate
                setup_journald
                install_rsyslog
                clear_docker
                delete_archives
                clear_cache
                ;;
            0) echo "Ð’Ñ‹Ñ…Ð¾Ð´."; exit 0 ;;
            *) echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°." ;;
        esac
    done
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ
main_menu
